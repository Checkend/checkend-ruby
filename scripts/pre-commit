#!/bin/bash

# Pre-commit hook to prevent secrets from being committed
# Scans staged files for common secret patterns

set -e

echo "ğŸ” Scanning for secrets..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}âœ“ No files to check${NC}"
    exit 0
fi

SECRETS_FOUND=0

# Function to check a pattern and report findings
check_pattern() {
    local pattern="$1"
    local description="$2"
    local result

    result=$(echo "$STAGED_FILES" | xargs grep -l -E "$pattern" 2>/dev/null || true)

    if [ -n "$result" ]; then
        echo -e "${RED}âœ— Potential $description found in:${NC}"
        echo "$result" | while read -r file; do
            echo "  - $file"
            grep -n -E "$pattern" "$file" 2>/dev/null | head -3 | while read -r line; do
                echo "      $line"
            done
        done
        SECRETS_FOUND=1
    fi
}

# Check for .env files being committed
ENV_FILES=$(echo "$STAGED_FILES" | grep -E '\.env($|\.)' || true)
if [ -n "$ENV_FILES" ]; then
    echo -e "${RED}âœ— Environment files should not be committed:${NC}"
    echo "$ENV_FILES" | while read -r file; do
        echo "  - $file"
    done
    SECRETS_FOUND=1
fi

# Check for private key files
KEY_FILES=$(echo "$STAGED_FILES" | grep -E '\.(pem|key|p12|pfx)$' || true)
if [ -n "$KEY_FILES" ]; then
    echo -e "${RED}âœ— Private key files should not be committed:${NC}"
    echo "$KEY_FILES" | while read -r file; do
        echo "  - $file"
    done
    SECRETS_FOUND=1
fi

# AWS Access Key ID
check_pattern 'AKIA[0-9A-Z]{16}' "AWS Access Key"

# Private keys
check_pattern 'BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY' "Private Key"

# GitHub tokens
check_pattern 'gh[pousr]_[A-Za-z0-9_]{36,}' "GitHub Token"
check_pattern 'github_pat_[A-Za-z0-9_]{22,}' "GitHub Personal Access Token"

# Stripe keys
check_pattern 'sk_live_[0-9a-zA-Z]{24,}' "Stripe Live Secret Key"
check_pattern 'rk_live_[0-9a-zA-Z]{24,}' "Stripe Live Restricted Key"

# Slack tokens
check_pattern 'xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}' "Slack Token"

# Google API Key
check_pattern 'AIza[0-9A-Za-z_-]{35}' "Google API Key"

# Database connection strings with passwords
check_pattern '(mongodb|postgres|mysql|redis)://[^:]+:[^@]+@' "Database Connection String with Password"

# JWT tokens
check_pattern 'eyJ[a-zA-Z0-9_-]*\.eyJ[a-zA-Z0-9_-]*\.[a-zA-Z0-9_-]*' "JWT Token"

# OpenAI API keys (sk-proj-... or sk-...)
check_pattern 'sk-proj-[a-zA-Z0-9_-]{40,}' "OpenAI Project API Key"
check_pattern 'sk-[a-zA-Z0-9]{48,}' "OpenAI API Key"

# Anthropic API keys (sk-ant-...)
check_pattern 'sk-ant-[a-zA-Z0-9_-]{40,}' "Anthropic API Key"

# OpenRouter API keys (sk-or-...)
check_pattern 'sk-or-[a-zA-Z0-9_-]{40,}' "OpenRouter API Key"

# Check result
if [ "$SECRETS_FOUND" -eq 1 ]; then
    echo ""
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘  COMMIT BLOCKED: Potential secrets detected!               â•‘${NC}"
    echo -e "${RED}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${RED}â•‘  Please remove secrets before committing.                  â•‘${NC}"
    echo -e "${RED}â•‘                                                            â•‘${NC}"
    echo -e "${RED}â•‘  If this is a false positive, you can:                     â•‘${NC}"
    echo -e "${RED}â•‘  1. Add to .gitignore if the file shouldn't be tracked     â•‘${NC}"
    echo -e "${RED}â•‘  2. Use: git commit --no-verify (use with caution!)        â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ No secrets detected${NC}"
exit 0
